<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>마이페이지</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
            background: #fafafa
        }

        .topbar h1 {
            margin: 0;
            font-size: 1.5rem
        }

        .btn {
            cursor: pointer;
            border-radius: 10px;
            padding: 10px 14px;
            border: 1px solid transparent;
            font-weight: 600
        }

        .btn-primary {
            background: #2563eb;
            color: #fff
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #111827;
            border-color: #e5e7eb
        }

        .btn-outline {
            background: transparent;
            border-color: #d1d5db;
            color: #111827
        }

        .container {
            max-width: 760px;
            margin: 32px auto;
            padding: 0 16px
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, .06);
            padding: 24px
        }

        .section-title {
            font-size: 1.125rem;
            margin: 0 0 16px 0
        }

        .row {
            display: flex;
            gap: 16px;
            padding: 14px 0;
            border-bottom: 1px solid #f3f3f3
        }

        .row:last-child {
            border-bottom: none
        }

        .label {
            width: 120px;
            color: #6b7280;
            font-weight: 700;
            line-height: 36px
        }

        .value {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap
        }

        .value span {
            min-height: 36px;
            display: inline-flex;
            align-items: center
        }

        .input {
            display: none;
            width: 100%;
            max-width: 340px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: flex-end;
            flex-wrap: wrap
        }

        .pw-actions {
            display: none;
            gap: 12px
        }

        /* 편집(프로필) 모드 */
        body.editing #btn-edit,
        body.editing #btn-password {
            display: none
        }

        body:not(.editing) #btn-save,
        body:not(.editing) #btn-cancel,
        body:not(.editing) .input {
            display: none
        }

        body.editing .editable .input {
            display: inline-block
        }

        body.editing .editable .value span {
            display: none
        }

        /* 비밀번호 변경 모드 */
        #pw-section {
            display: none;
            margin-top: 8px
        }

        #pw-section .input {
            display: inline-block
        }

        /* 비번 입력은 항상 노출 */
        body.pw-editing #pw-section {
            display: block
        }

        body.pw-editing #btn-edit,
        body.pw-editing #btn-password,
        body.pw-editing #btn-save,
        body.pw-editing #btn-cancel {
            display: none
        }

        body.pw-editing .pw-actions {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
        }

        /* 요청 사항: 비번 변경 모드일 때 위 수정 영역 숨김 */
        .profile-view {
        }

        /* 래퍼 */
        body.pw-editing .profile-view {
            display: none
        }
    </style>
</head>
<body>
<header class="topbar">
    <h1 th:text="'안녕하세요, ' + ${user.username} + '님'"></h1>
    <div>
        <button type="button" class="btn btn-outline" onclick="logout()">로그아웃</button>
    </div>
</header>

<main class="container">
    <section class="card">
        <h2 class="section-title" id="mypage-title">내 정보</h2>

        <input type="hidden" th:value="${user.id}" id="user-id"/>

        <!-- ▼ 프로필 표시/수정 영역 (pw-editing에서 숨김) -->
        <div class="profile-view">
            <div class="row">
                <div class="label">아이디</div>
                <div class="value"><span id="v-username" th:text="${user.username}"></span></div>
            </div>

            <div class="row editable">
                <div class="label">이메일</div>
                <div class="value">
                    <span id="v-email" th:text="${user.email}"></span>
                    <input class="input" type="email" id="i-email" th:value="${user.email}"
                           placeholder="email@example.com"/>
                </div>
            </div>

            <div class="row editable">
                <div class="label">나이</div>
                <div class="value">
                    <span id="v-age" th:text="${user.age}"></span>
                    <input class="input" type="number" min="0" id="i-age" th:value="${user.age}"/>
                </div>
            </div>

            <div class="row">
                <div class="label">가입일</div>
                <div class="value"><span th:text="${#temporals.format(user.regDt, 'yyyy-MM-dd HH:mm')}"></span></div>
            </div>
        </div>
        <!-- ▲ 프로필 영역 -->

        <!-- ▼ 비밀번호 변경 섹션 (pw-editing에서만 표시) -->
        <div id="pw-section">
            <div class="row pw-row">
                <div class="label">현재 비밀번호</div>
                <div class="value"><input class="input" type="password" id="i-current-pw" placeholder="현재 비밀번호"/></div>
            </div>
            <div class="row pw-row">
                <div class="label">새 비밀번호</div>
                <div class="value"><input class="input" type="password" id="i-new-pw" placeholder="새 비밀번호"/></div>
            </div>
            <div class="row pw-row">
                <div class="label">새 비밀번호 확인</div>
                <div class="value"><input class="input" type="password" id="i-new-pw2" placeholder="새 비밀번호 확인"/></div>
            </div>
        </div>
        <!-- ▲ 비밀번호 변경 섹션 -->

        <div class="actions">
            <!-- 프로필용 버튼 -->
            <button type="button" id="btn-edit" class="btn btn-primary" onclick="editMode(true)">수정</button>
            <button type="button" id="btn-password" class="btn btn-primary" onclick="pwMode(true)">비밀번호 변경</button>
            <button type="button" id="btn-save" class="btn btn-primary" onclick="saveInfo()">저장</button>
            <button type="button" id="btn-cancel" class="btn btn-secondary" onclick="editMode(false)">취소</button>

            <!-- 비밀번호 변경 전용 버튼 (우측 정렬) -->
            <div class="pw-actions">
                <button type="button" class="btn btn-primary" onclick="savePassword()">비밀번호 저장</button>
                <button type="button" class="btn btn-secondary" onclick="pwMode(false)">취소</button>
            </div>
        </div>
    </section>
</main>

<script>
    const $text = id => document.getElementById(id).textContent.trim();
    const toggleEditing = on => document.body.classList.toggle('editing', !!on);
    const togglePwEditing = on => document.body.classList.toggle('pw-editing', !!on);

    // 초기 상태
    toggleEditing(false);
    togglePwEditing(false);

    function editMode(on) {
        document.querySelector('#mypage-title').innerHTML = on ? '내 정보 수정' : '내 정보';
        document.querySelector('#i-email').value = $text('v-email');
        document.querySelector('#i-age').value = $text('v-age');
        togglePwEditing(false);
        toggleEditing(on);
    }

    function pwMode(on) {
        toggleEditing(false);
        togglePwEditing(on);
        document.querySelector('#mypage-title').innerHTML = on ? '비밀번호 변경' : '내 정보';
        if (!on) {
            document.getElementById('i-current-pw').value = '';
            document.getElementById('i-new-pw').value = '';
            document.getElementById('i-new-pw2').value = '';
        }
    }

    async function saveInfo() {
        const email = document.querySelector('#i-email').value.trim();
        const age = parseInt(document.querySelector('#i-age').value, 10);
        if (!email) {
            alert('이메일을 입력하세요.');
            return;
        }
        if (Number.isNaN(age) || age < 0) {
            alert('나이를 올바르게 입력하세요.');
            return;
        }

        const payload = {
            id: document.querySelector('#user-id').value,
            email: email,
            age: age,
            type: 'info'
        };
        const res = await fetch('/api/user/modify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        alert(res.ok ? '수정 완료' : '수정 실패');
        if (res.ok) {
            document.getElementById('v-email').textContent = email;
            document.getElementById('v-age').textContent = String(age);
            toggleEditing(false);
        }
    }

    async function savePassword() {
        const id = document.getElementById('user-id').value;
        const current = document.getElementById('i-current-pw').value;
        const npw = document.getElementById('i-new-pw').value;
        const npw2 = document.getElementById('i-new-pw2').value;

        if (!current || !npw || !npw2) {
            alert('모든 항목을 입력하세요.');
            return;
        }
        if (npw !== npw2) {
            alert('새 비밀번호가 일치하지 않습니다.');
            return;
        }

        const payload = {
            id: id,
            password: current,
            newPassword: npw,
            type: 'password'
        };

        const res = await fetch('/api/user/modify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        let message = '비밀번호가 변경되었습니다.';
        if (res.ok) {
            pwMode(false);
        } else {
            const response = await res.json();
            message = response.message;
        }
        alert(message);
    }

    function logout() {
        location.href = '/logout';
    }
</script>
</body>
</html>
